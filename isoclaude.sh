#!/bin/bash
# IsoClaude - Isolated Ubuntu Desktop for Claude Development
# Usage: ./isoclaude.sh [up|down|setup|regenerate]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
COMPOSE_FILE="$SCRIPT_DIR/docker-compose.yml"
PROJECTS_CONF="$SCRIPT_DIR/projects.conf"

generate_compose() {
    echo "Generating docker-compose.yml from projects.conf..."

    # Start compose file
    cat > "$COMPOSE_FILE" << 'HEADER'
# Auto-generated by isoclaude.sh - do not edit manually
# Edit projects.conf and run: ./isoclaude.sh regenerate

services:
  iso-claude-ubuntu:
    image: lscr.io/linuxserver/webtop:ubuntu-kde
    container_name: iso-claude-ubuntu
    ports:
      - "3000:3000"
      - "2222:22"
    volumes:
      # User data and config
      - ubuntu-config:/config
      # Persist system directories for installed software
      - ubuntu-usr:/usr
      - ubuntu-opt:/opt
      - ubuntu-var:/var
      - ubuntu-root:/root
      # Setup script
      - ./setup-container.sh:/setup-container.sh:ro
HEADER

    # Parse projects.conf and add mounts
    local volume_count=0
    while IFS= read -r line || [[ -n "$line" ]]; do
        # Skip comments and empty lines
        [[ "$line" =~ ^#.*$ || -z "$line" ]] && continue

        # Parse path:include_git
        path="${line%%:*}"
        include_git="${line##*:}"

        # Get folder name for mount point
        folder_name="$(basename "$path")"

        # Add project mount
        echo "      # Project: $folder_name" >> "$COMPOSE_FILE"
        echo "      - $path:/projects/$folder_name" >> "$COMPOSE_FILE"

        # If not including git, shadow it with a volume
        if [[ "$include_git" == "false" ]]; then
            echo "      - git-exclude-$volume_count:/projects/$folder_name/.git" >> "$COMPOSE_FILE"
            ((volume_count++))
        fi
    done < "$PROJECTS_CONF"

    # Add volumes section
    cat >> "$COMPOSE_FILE" << 'VOLUMES'
    shm_size: "2gb"
    restart: unless-stopped

volumes:
  ubuntu-config:
  ubuntu-usr:
  ubuntu-opt:
  ubuntu-var:
  ubuntu-root:
VOLUMES

    # Add git-exclude volumes
    for ((i=0; i<volume_count; i++)); do
        echo "  git-exclude-$i:" >> "$COMPOSE_FILE"
    done

    echo "Generated $COMPOSE_FILE"
}

cmd_up() {
    if [[ ! -f "$COMPOSE_FILE" ]]; then
        generate_compose
    fi
    docker compose -f "$COMPOSE_FILE" up -d
    echo ""
    echo "Ubuntu Desktop running at: http://localhost:3000"
    echo "Run './isoclaude.sh setup' to install dev tools (first time only)"
}

cmd_down() {
    docker compose -f "$COMPOSE_FILE" down
}

cmd_setup() {
    echo "Installing development tools in container..."
    docker exec iso-claude-ubuntu /setup-container.sh
}

cmd_regenerate() {
    generate_compose
    echo ""
    echo "Restart with: ./isoclaude.sh down && ./isoclaude.sh up"
}

cmd_help() {
    cat << 'HELP'
IsoClaude - Isolated Ubuntu Desktop for Claude Development

Usage: ./isoclaude.sh <command>

Commands:
  up          Start the container (generates compose file if needed)
  down        Stop the container (data persists)
  setup       Install Python 3.12/3.13, Poetry, Claude CLI (first time)
  regenerate  Regenerate docker-compose.yml from projects.conf
  help        Show this help

Configuration:
  Edit projects.conf to add/remove project mounts
  Format: /path/to/project:include_git (true/false)

Examples:
  ./isoclaude.sh up           # Start container
  ./isoclaude.sh setup        # Install dev tools
  ./isoclaude.sh regenerate   # After editing projects.conf
  ./isoclaude.sh down         # Stop (data persists)
HELP
}

# Main
case "${1:-help}" in
    up) cmd_up ;;
    down) cmd_down ;;
    setup) cmd_setup ;;
    regenerate) cmd_regenerate ;;
    help|--help|-h) cmd_help ;;
    *) echo "Unknown command: $1"; cmd_help; exit 1 ;;
esac
